import logging
from typing import Any, Dict, List, Set
from backend.core.logger import CTILogger
from backend.parser.base_parser import BaseParser

logger = CTILogger.get_logger(__name__)

class VulnerabilityParser(BaseParser):
    """
    Parser for CISA KEV and AlienVault OTX.
    Optimized for high-signal vulnerability intelligence.
    """

    def __init__(self, config: Dict[str, Any] = None):
        super().__init__(
            name="vulnerability_parser",
            config=config or {}
        )

    def parse(self, raw_data: Dict[str, Any]) -> List[Dict[str, Any]]:
        source = raw_data.get("source", "unknown")
        
        if source == "cisa_kev":
            return self._parse_cisa_kev(raw_data)
        elif source == "alienvault_otx":
            return self._parse_otx(raw_data)
        
        logger.warning(f"Unsupported source for VulnerabilityParser: {source}")
        return []

    def _parse_cisa_kev(self, raw_data: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Parses CISA Known Exploited Vulnerabilities catalog."""
        items = []
        # CISA KEV structure: vulnerabilities -> list of objects
        vulnerabilities = raw_data.get("data", {}).get("vulnerabilities", [])

        for vuln in vulnerabilities:
            cve_id = vuln.get("cveID")
            if not cve_id:
                continue

            # Normalize the CVE as a primary indicator
            items.append(self.normalize_ioc(
                ioc_type="cve",
                ioc_value=cve_id.upper(),
                metadata={
                    "source": "cisa_kev",
                    "product": vuln.get("product"),
                    "vendor": vuln.get("vendorProject"),
                    "vulnerability_name": vuln.get("vulnerabilityName"),
                    "ransomware_use": vuln.get("knownRansomwareCampaignUse", "Unknown"),
                    "date_added": vuln.get("dateAdded")
                }
            ))
        return items

    def _parse_otx(self, raw_data: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Parses AlienVault OTX Pulses specifically for CVE associations."""
        items = []
        data = raw_data.get("data", {})
        pulses = data.get("pulses", [])

        for pulse in pulses:
            # Efficiently extract CVEs from the structured 'indicators' list 
            # rather than using regex on the description.
            indicators = pulse.get("indicators", [])
            for ind in indicators:
                if ind.get("type") == "CVE":
                    items.append(self.normalize_ioc(
                        ioc_type="cve",
                        ioc_value=ind.get("indicator", "").upper(),
                        metadata={
                            "source": "alienvault_otx",
                            "pulse_id": pulse.get("id"),
                            "pulse_name": pulse.get("name"),
                            "tags": pulse.get("tags", []),
                            "description": pulse.get("description")
                        }
                    ))
        return items

    def extract_iocs(self, parsed_data: List[Dict[str, Any]]) -> Dict[str, Set[str]]:
        """Groups results with unique Sets to prevent CVE duplication."""
        iocs_by_type: Dict[str, Set[str]] = {}
        for item in parsed_data:
            itype = item["ioc_type"]
            if itype not in iocs_by_type:
                iocs_by_type[itype] = set()
            iocs_by_type[itype].add(item["ioc_value"])
        return iocs_by_type