import logging
from typing import Any, Dict, List, Set
from backend.core.logger import CTILogger
from backend.parser.base_parser import BaseParser

logger = CTILogger.get_logger(__name__)

class MalpediaParser(BaseParser):
    """
    Optimized parser for Malpedia Public MISP Galaxy data.
    Does not require a Malpedia account.
    """

    def __init__(self, config: Dict[str, Any] = None):
        super().__init__(
            name="malpedia",
            config=config or {}
        )

    def parse(self, raw_data: Dict[str, Any]) -> List[Dict[str, Any]]:
        """
        Parses the Malpedia MISP Galaxy format.
        Structure: raw_data['data']['families'] -> list of malware clusters.
        """
        normalized_items = []
        
        # Malpedia's /get/misp endpoint returns a 'values' list in the galaxy format
        families = raw_data.get("data", {}).get("families", [])
        
        for entry in families:
            # Main family name (e.g., 'Emotet')
            family_name = entry.get("value")
            meta = entry.get("meta", {})
            
            # 1. Normalize the Malware Family itself as an IOC
            family_metadata = {
                "synonyms": meta.get("synonyms", []),
                "description": entry.get("description", ""),
                "attribution": meta.get("attribution", []),
                "type": meta.get("type", "malware_family")
            }
            
            normalized_items.append(
                self.normalize_ioc(
                    ioc_type="malware_family",
                    ioc_value=family_name,
                    metadata=family_metadata
                )
            )

            # 2. Extract External References (URLs) if available in the meta
            for ref in meta.get("refs", []):
                normalized_items.append(
                    self.normalize_ioc(
                        ioc_type="url",
                        ioc_value=ref,
                        metadata={"malware_family": family_name, "context": "reference_link"}
                    )
                )

        return normalized_items

    def extract_iocs(self, parsed_data: List[Dict[str, Any]]) -> Dict[str, Set[str]]:
        """
        Efficiently groups IOCs by type using Sets for automatic deduplication.
        """
        iocs_by_type: Dict[str, Set[str]] = {}

        for ioc in parsed_data:
            itype = ioc["ioc_type"]
            ivalue = ioc["ioc_value"]
            
            if itype not in iocs_by_type:
                iocs_by_type[itype] = set()
            
            iocs_by_type[itype].add(ivalue)
            
            # If it's a malware family, we also want to index its synonyms as searchable IOCs
            if itype == "malware_family":
                for synonym in ioc["metadata"].get("synonyms", []):
                    iocs_by_type[itype].add(synonym)

        return iocs_by_type

